

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Initial Deployment &mdash; Pushkin 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Local Deployment" href="localDeployment.html" />
    <link rel="prev" title="Welcome to Pushkin’s documentation!" href="../index.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Pushkin
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Initial Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup-aws">Setup AWS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#define-security-groups">Define security groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-an-ec2">Get an EC2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-databases-rds">Get databases (RDS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prepare-the-transactions-database">Prepare the transactions database</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-an-s3-bucket">Get an S3 Bucket</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-cloudfront">Get Cloudfront</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-aws-cli-tools">Get AWS CLI Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="#set-up-an-iam-user">Set up an IAM User</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#setup-rancher">Setup Rancher</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#login-to-rancher">Login to Rancher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-a-password">Add a Password</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-a-host">Add a host</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#prepare-locally">Prepare Locally</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#set-variables">Set Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preparetodeploy">prepareToDeploy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-new-stack">Create a new stack</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="localDeployment.html">Local Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintenance/maintenance.html">Maintenance</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pushkin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Initial Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/deployment/initialDeployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="initial-deployment">
<span id="id1"></span><h1>Initial Deployment<a class="headerlink" href="#initial-deployment" title="Permalink to this headline">¶</a></h1>
<p>Walk through the initial setup of Pushkin infrastructure.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>These instructions assume you have:</p>
<ul class="simple">
<li>a working version of Pushkin</li>
<li>access to AWS</li>
<li>a Docker (Hub) account</li>
</ul>
</div>
<div class="section" id="setup-aws">
<h2>Setup AWS<a class="headerlink" href="#setup-aws" title="Permalink to this headline">¶</a></h2>
<div class="section" id="define-security-groups">
<h3>Define security groups<a class="headerlink" href="#define-security-groups" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>You’ll need two security groups: one for rancher and one for the databases.</p>
<p>The rancher EC2 security group should be open to all traffic on ports</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Port</th>
<th class="head">Protocol</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>80</td>
<td>TCP</td>
</tr>
<tr class="row-odd"><td>443</td>
<td>TCP</td>
</tr>
<tr class="row-even"><td>8080</td>
<td>TCP</td>
</tr>
<tr class="row-odd"><td>500</td>
<td>UDP</td>
</tr>
<tr class="row-even"><td>4500</td>
<td>UDP</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>This is for normal web access, the rancher management web UI, and the Rancher host infrastructure.
The database security group should be open to all TCP traffic on ports 3306 (MySQL) and 5432 (Postgres).
Instructions on creating a security group can be found on AWS.
.. todo:: Add link for instructions.</p>
</div></blockquote>
</div>
<div class="section" id="get-an-ec2">
<h3>Get an EC2<a class="headerlink" href="#get-an-ec2" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The most straightforward way to do this is to use the official Rancher OS already on Amazon. Create it with the AMI from the list here appropriate to your region.</p>
<p>Instructions on creating EC2 instances can be found on AWS.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Add link for instructions.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="get-databases-rds">
<h3>Get databases (RDS)<a class="headerlink" href="#get-databases-rds" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>You’ll need three databases. One’s for rancher, one’s for transactions, and one’s for stored data. Launch all three with the database security group created previously. t2.medium is the recommended size for all of them.</p>
<ul class="simple">
<li>Rancher DB: MySQL</li>
<li>Transaction DB: Postgres</li>
<li>Data DB: Postgres</li>
</ul>
<p>Instructions on creating RDS Instances can be found on AWS.</p>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">Add link for instructions.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="prepare-the-transactions-database">
<h3>Prepare the transactions database<a class="headerlink" href="#prepare-the-transactions-database" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Connect to the transactions database just created using any Postgres client and run the following code to make a transactions table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">create</span> <span class="n">table</span> <span class="n">transactions</span> <span class="p">(</span>
   <span class="nb">id</span>  <span class="n">SERIAL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
   <span class="n">query</span> <span class="n">TEXT</span> <span class="ow">not</span> <span class="n">null</span><span class="p">,</span>
   <span class="n">bindings</span> <span class="n">TEXT</span>
<span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="get-an-s3-bucket">
<h3>Get an S3 Bucket<a class="headerlink" href="#get-an-s3-bucket" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Create a new S3 bucket with open permissions for all traffic.</p>
<div class="admonition-todo admonition" id="index-2">
<p class="first admonition-title">Todo</p>
<p class="last">Give more details.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="get-cloudfront">
<h3>Get Cloudfront<a class="headerlink" href="#get-cloudfront" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Setup cloudfront to point to the new bucket.</p>
<div class="admonition-todo admonition" id="index-3">
<p class="first admonition-title">Todo</p>
<p class="last">Give more details.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="get-aws-cli-tools">
<h3>Get AWS CLI Tools<a class="headerlink" href="#get-aws-cli-tools" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>Follow Amazon’s instructions for installing the AWS CLI <a class="reference external" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html">here</a>. Alternatively, you could use <a class="reference external" href="https://brew.sh">Homebrew</a> if you’re on a Mac.</div></blockquote>
</div>
<div class="section" id="set-up-an-iam-user">
<h3>Set up an IAM User<a class="headerlink" href="#set-up-an-iam-user" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This will be programmatic access from the command line AWS tools via the prepareToDeploy.sh script.</p>
<p>Run <code class="docutils literal notranslate"><span class="pre">aws</span> <span class="pre">configure</span></code> from your local computer and enter in the appropriate information to set up the AWS CLI.</p>
<div class="admonition-todo admonition" id="index-4">
<p class="first admonition-title">Todo</p>
<p class="last">Give more details.</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="setup-rancher">
<h2>Setup Rancher<a class="headerlink" href="#setup-rancher" title="Permalink to this headline">¶</a></h2>
<div class="section" id="login-to-rancher">
<h3>Login to Rancher<a class="headerlink" href="#login-to-rancher" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>SSH into the Rancher EC2 instance and start the docker container for Rancher. Replace the capitalized parts of the following command with the information for the rancher database created earlier.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker run -d --restart<span class="o">=</span>unless-stopped --name<span class="o">=</span>rancher -p <span class="m">8080</span>:8080 rancher/server --db-host DB_URL --db-port <span class="m">3306</span> --db-user DB_USER --db-pass DB_PASSWORD --db-name DB_NAME
</pre></div>
</div>
<p>You should now be able to connect to Rancher’s web interface by going to the EC2 URL at port 8080.</p>
</div></blockquote>
</div>
<div class="section" id="add-a-password">
<h3>Add a Password<a class="headerlink" href="#add-a-password" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>Go to Admin &gt; Access Control and set up an access control type of your choice.</div></blockquote>
</div>
<div class="section" id="add-a-host">
<h3>Add a host<a class="headerlink" href="#add-a-host" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>Go to Infrastructure &gt; Hosts &gt; Add Host. Use the public IP of the current Rancher EC2 instance for the public IP of the host and run the command given in the SSH connection already open.</div></blockquote>
</div>
</div>
<div class="section" id="prepare-locally">
<h2>Prepare Locally<a class="headerlink" href="#prepare-locally" title="Permalink to this headline">¶</a></h2>
<div class="section" id="set-variables">
<h3>Set Variables<a class="headerlink" href="#set-variables" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>The “.env” file in the root directory of Pushkin is used to house the configuration of a myriad of settings. Open it in a plain text editor and enter in the corresponding information for each line.</div></blockquote>
</div>
<div class="section" id="preparetodeploy">
<h3>prepareToDeploy<a class="headerlink" href="#preparetodeploy" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This step of deployment has been greatly simplified with the inclusion of the script “prepareToDeploy.sh”, which is located in the root folder of the repo. Make sure the Docker daemon is running and then execute this script from a terminal (e.g. <code class="docutils literal notranslate"><span class="pre">./prepareToDeploy.sh</span></code>).</p>
<p>It will prompt you for multiple things. Follow as you wish. Unless you’ve modified the Pushkin structure or changed important file names, the defaults should be all set.</p>
<p>It will handle compiling the website, copying over files to the server, creating docker images, uploading those images to docker hub, and syncing static website files with the S3 bucket. Finally, it will generate a new docker compose file that’s free of all environment variables (set in .env, the environment file), which will satisfy rancher.</p>
</div></blockquote>
</div>
<div class="section" id="create-a-new-stack">
<h3>Create a new stack<a class="headerlink" href="#create-a-new-stack" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div>Go to Stacks &gt; New Stack in the Rancher web UI and upload the docker-compose file the prepareToDeploy script generated for you (called “docker-compose.production.noEnvDependency.yml” by default).</div></blockquote>
<div class="admonition-todo admonition" id="index-5">
<p class="first admonition-title">Todo</p>
<dl class="last docutils">
<dt>Add in information regarding:</dt>
<dd><ul class="first last simple">
<li>load balancing</li>
<li>autoscaling</li>
<li>notes on cloudfront invalidation (see <a class="reference external" href="https://aws.amazon.com/blogs/aws/new-cloudfront-feature-invalidation/">here</a>)</li>
</ul>
</dd>
</dl>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="localDeployment.html" class="btn btn-neutral float-right" title="Local Deployment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral" title="Welcome to Pushkin’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Joshua Hartshorne.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>